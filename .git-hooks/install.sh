#!/bin/bash
set -e

echo "üîó –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git hooks..."

HOOKS_DIR=".git/hooks"
CUSTOM_DIR=".git-hooks"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ .git/hooks
if [ ! -d "$HOOKS_DIR" ]; then
    echo "üìå –ü–∞–ø–∫–∞ $HOOKS_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—ë–º..."
    mkdir -p "$HOOKS_DIR"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ø–∞–ø–∫–∏
if [ ! -d "$CUSTOM_DIR" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ $CUSTOM_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –µ—ë –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ç—É–¥–∞ pre-commit –∏ pre-push."
    exit 1
fi

HOOKS=("pre-commit" "pre-push")

# –î–µ–ª–∞–µ–º –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ø–∞–ø–∫–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
chmod +x "$CUSTOM_DIR"/*.sh
echo "üîß –ü—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ö—É–∫–æ–≤."

# –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫–∏
for HOOK in "${HOOKS[@]}"; do
    TARGET="$HOOKS_DIR/$HOOK"

    # –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª/—Å–∏–º–ª–∏–Ω–∫
    if [ -L "$TARGET" ]; then
        LINK_TARGET=$(readlink "$TARGET")
        if [[ "$LINK_TARGET" == *"$CUSTOM_DIR"* ]]; then
            echo "‚ÑπÔ∏è –°—Ç–∞—Ä—ã–π —Ö—É–∫ $HOOK –Ω–∞–π–¥–µ–Ω –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è."
            rm -f "$TARGET"
        else
            echo "‚ö†Ô∏è –•—É–∫ $HOOK –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω, —ç—Ç–æ –Ω–µ –Ω–∞—à —Å–∏–º–ª–∏–Ω–∫ ($LINK_TARGET)"
            continue
        fi
    elif [ -f "$TARGET" ]; then
        echo "‚ö†Ô∏è –•—É–∫ $HOOK –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–ª–∏–Ω–∫–æ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π."
        continue
    fi

    ln -s "../../$CUSTOM_DIR/$HOOK" "$TARGET"
    echo "‚úÖ Hook $HOOK –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
done

echo "üéâ Git hooks —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã!"
